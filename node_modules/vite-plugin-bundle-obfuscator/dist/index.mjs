import se from"path";import{fileURLToPath as ae}from"url";var ue=()=>ae(import.meta.url),le=()=>se.dirname(ue()),x=le();import*as A from"vite";import{Worker as pe}from"worker_threads";import de from"path";import fe from"os";import{gzipSync as ge}from"zlib";import J from"javascript-obfuscator";import{existsSync as j,readFileSync as ce}from"fs";import{resolve as S}from"path";var{toString:O}=Object.prototype;function T(t){return O.call(t)==="[object RegExp]"}function _(t){return O.call(t)==="[object String]"}function m(t){return O.call(t)==="[object Object]"}function F(t){return Array.isArray(t)}function $(t){let e=O.call(t);return e==="[object Function]"||e==="[object AsyncFunction]"}function E(t){return O.call(t)==="[object Boolean]"}function w(t,e){return e?F(e)?e.some(n=>_(n)?t.includes(n):T(n)?n.test(t):!1):_(e)?t.includes(e):T(e)?e.test(t):!1:!1}function N(t){return!!t.build?.lib}function H(t){let e=t.root||process.cwd(),n=S(e,"package.json");if(j(n))try{let r=JSON.parse(ce(n,"utf-8"));if({...r.dependencies,...r.devDependencies}.nuxt)return!0}catch{}return[S(e,"nuxt.config.js"),S(e,"nuxt.config.ts"),S(e,".nuxt"),S(e,".output")].some(r=>j(r))}var D={excludes:[],enable:!0,log:!0,apply:"build",autoExcludeNodeModules:!1,threadPool:!1,options:{compact:!0,controlFlowFlattening:!0,controlFlowFlatteningThreshold:1,deadCodeInjection:!1,debugProtection:!1,debugProtectionInterval:0,disableConsoleOutput:!1,identifierNamesGenerator:"hexadecimal",log:!1,numbersToExpressions:!1,renameGlobals:!1,selfDefending:!0,simplify:!0,splitStrings:!1,ignoreImports:!0,stringArray:!0,stringArrayCallsTransform:!0,stringArrayCallsTransformThreshold:.5,stringArrayEncoding:[],stringArrayIndexShift:!0,stringArrayRotate:!0,stringArrayShuffle:!0,stringArrayWrappersCount:1,stringArrayWrappersChainedCalls:!0,stringArrayWrappersParametersMaxCount:2,stringArrayWrappersType:"variable",stringArrayThreshold:.75,unicodeEscapeSequence:!1}},I="node_modules",k="vendor-modules",V="vendor-",L=(o=>(o.B="B",o.KB="KB",o.MB="MB",o))(L||{}),h=Object.freeze({info:"\x1B[36m",warn:"\x1B[33m",success:"\x1B[32m"});var y=class{constructor(e){this._log=e?console.log.bind(console):this.noop}noop(){}forceLog(...e){console.log(...e)}info(e){this._log(e)}};function U(){return A?.version?Number(A.version.split(".")[0]):2}function me(t){let e=Math.floor(t/36e5),n=Math.floor(t%36e5/6e4),o=Math.floor(t%6e4/1e3);return[e?`${e}h `:"",n?`${n}m `:"",o||!e&&!n?`${o}s`:""].filter(Boolean).join("")}function G(t){return E(t)?t:m(t)&&"enable"in t?t.enable:!1}function K(t){return G(t.threadPool)}function X(t){return G(t.autoExcludeNodeModules)}function q(t){let{autoExcludeNodeModules:e}=t;return E(e)?[]:m(e)&&e.enable?e.manualChunks||[]:[]}function P(t){return V+t}function Q(t){let{threadPool:e}=t,n=fe.cpus().length;return E(e)?n:m(e)&&e.enable&&e.size?e.size:n}function Y(t,e){let n=[];return Object.entries(e).forEach(([o,r])=>{"code"in r&&r.code&&!w(o,t.excludes)&&n.push([o,r])}),n}function Z(t,e){for(let n of e)if(t.includes(n))return P(n);return k}var z=class t{constructor(){this.obfuscatedFiles=new Set}static getInstance(){return t.instance||(t.instance=new t),t.instance}markAsObfuscated(e){e&&this.obfuscatedFiles.add(e)}isObfuscated(e){return e?this.obfuscatedFiles.has(e):!1}getAllObfuscatedFiles(){return Array.from(this.obfuscatedFiles)}clear(){this.obfuscatedFiles.clear()}serialize(){return Array.from(this.obfuscatedFiles)}updateFromSerialized(e){!e||!Array.isArray(e)||e.forEach(n=>{this.obfuscatedFiles.add(n)})}};function ee(t,e,n){let o=new y(t.log),r=z.getInstance();if(r.isObfuscated(e))return o.info(`skipping ${e} (already in obfuscated registry)`),{code:n.code,map:n.map};o.info(`obfuscating ${e}...`);let u=t.options.sourceMap?{...t.options,inputFileName:e,sourceMapFileName:`${e}.map`}:t.options,i=J.obfuscate(n.code,u);o.info(`obfuscation complete for ${e}.`),r.markAsObfuscated(e),o.info(`added ${e} to obfuscated files registry`);let b=i.getSourceMap();return{code:i.getObfuscatedCode(),map:b?JSON.parse(b):null}}function te(t,e,n){let o=new y(t.log),r=z.getInstance();if(r.isObfuscated(e))return o.info(`skipping ${e} (already in obfuscated registry)`),{code:n,map:null};o.info(`obfuscating ${e}...`);let u=t.options.sourceMap?{...t.options,inputFileName:e,sourceMapFileName:`${e}.map`}:t.options,i=J.obfuscate(n,u);return o.info(`obfuscation complete for ${e}.`),r.markAsObfuscated(e),o.info(`added ${e} to obfuscated files registry`),{code:i.getObfuscatedCode(),map:JSON.parse(i.getSourceMap()||"null")}}function ne(t,e){return new Promise((n,o)=>{let r=new pe(de.join(x,"./worker/index.mjs")),u=z.getInstance();r.postMessage({config:t,chunk:JSON.parse(JSON.stringify(e)),registryState:u.serialize()}),r.on("message",i=>{i.results&&Array.isArray(i.results)&&e.forEach(([b,C])=>{let g=i.results.find(M=>M.fileName===b);g&&g.obfuscatedCode&&(C.code=g.obfuscatedCode,C.map=g.map||null)}),i.registryState&&Array.isArray(i.registryState)&&u.updateFromSerialized(i.registryState),n(i),r.unref()}),r.on("error",i=>{o(i),r.unref()})})}function W(t){let e=Object.values(L),n=0;for(;t>=1024&&n<e.length-1;)t/=1024,n++;return{value:Number(t.toFixed(2)),unit:e[n]}}var v=class{constructor(e){this._log=e,this.originalSize=this.createEmptySizeResult(),this.obfuscatedSize=this.createEmptySizeResult(),this.startTime=0,this.endTime=0}createEmptySizeResult(){return{original:{value:0,unit:"B"},gzip:{value:0,unit:"B"}}}start(e){this.startTime=performance.now(),this.originalSize=this.calculateBundleSize(e)}end(e){this.obfuscatedSize=this.calculateBundleSize(e),this.endTime=performance.now(),this.logResult()}calculateBundleSize(e){let{totalSize:n,gzipSize:o}=e.reduce((r,[,u])=>{if(u.code){let{code:i}=u;r.totalSize+=Buffer.byteLength(i,"utf-8"),r.gzipSize+=ge(i,{level:9}).byteLength}return r},{totalSize:0,gzipSize:0});return{original:W(n),gzip:W(o)}}analyze(){let{originalSize:e,obfuscatedSize:n}=this,o=me(this.endTime-this.startTime),r=((n.original.value-e.original.value)/e.original.value*100).toFixed(2),u=((n.gzip.value-e.gzip.value)/e.gzip.value*100).toFixed(2);return`\u2713 obfuscated in ${o} | \u{1F4E6} ${e.original.value}${e.original.unit} (gzip: ${e.gzip.value}${e.gzip.unit}) \u2192 \u{1F512} ${n.original.value}${n.original.unit} (gzip: ${n.gzip.value}${n.gzip.unit}) | \u{1F4C8} ${r}% (gzip: ${u}%)`}logResult(){this._log.forceLog(h.success+"%s\x1B[0m",this.analyze())}};function be(t){let e={...D,...t},n=new y(e.log),o=!1,r=!1,u=!1,i=async s=>{n.forceLog(h.info+`
starting obfuscation process...`);let l=new v(n),a=Y(e,s);if(l.start(a),K(e)){let d=Math.min(Q(e),a.length),c=Math.ceil(a.length/d),f=[];for(let p=0;p<d;p++){let R=a.slice(p*c,(p+1)*c);f.push(ne(e,R))}await Promise.all(f)}else a.forEach(([d,c])=>{let{code:f,map:p}=ee(e,d,c);c.code=f,c.map=p});l.end(a)},b=(s,l)=>{if(u=!!l.isSsrBuild,o=N(s),r=H(s),!e.enable||!X(e)||o||r)return;s.build=s.build||{},s.build.rollupOptions=s.build.rollupOptions||{};let{output:a}=s.build.rollupOptions,d=[...q(e)],c=()=>{e.excludes.push(k,...d.map(P))},f=p=>{if(p.includes(I))return Z(p,d)};if(!a){c(),s.build.rollupOptions.output={manualChunks:f};return}if(F(a)){n.forceLog(h.warn,"rollupOptions.output is an array, ignoring autoExcludeNodeModules configuration.");return}if(m(a)){if(!a.manualChunks)c(),a.manualChunks=f;else if(m(a.manualChunks))n.forceLog(h.warn,"rollupOptions.output.manualChunks is an object, ignoring autoExcludeNodeModules configuration.");else if($(a.manualChunks)){let p=a.manualChunks;c(),a.manualChunks=(R,ie)=>f(R)||p(R,ie)}}},C=s=>{let l=s.build.sourcemap;l&&(e.options={...e.options,sourceMap:!0,sourceMapMode:l==="inline"?"inline":"separate"})},g=async(s,{bundle:l})=>(!e.enable||!l||r||u||await i(l),s),M=async(s,l)=>{!e.enable||!l||o||!r||u||await i(l)},oe=(s,l)=>{if(!e.enable||!o||u)return null;let a=new v(n),d=[[l.name,{code:s}]];a.start(d);let{code:c,map:f}=te(e,l.name,s);return a.end(d),{code:c,map:f}},re=()=>U()>=5?{order:"post",handler:g}:{enforce:"post",transform:g};return{name:"vite-plugin-bundle-obfuscator",apply:e.apply,config:b,configResolved:C,renderChunk:oe,transformIndexHtml:re(),generateBundle:M}}export{be as default};
